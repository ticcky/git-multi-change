#!/bin/bash

set -euo pipefail

if [[ ! -e .git ]]; then
    echo "No git repo found here."
    exit 1
fi

if [[ "$1" == "" ]]; then
    echo "No branch specified."
    exit 1
fi

function list_files_for_branch() {
	awk -v key="$1" '
	  $0 ~ "^#[[:space:]]*" key "[[:space:]]*$" { on=1; next }  # start of a wanted section
	  $0 ~ "^#[[:space:]]*"                        { on=0 }     # any header ends current section
	  on && $0 !~ "^[[:space:]]*$"                 { print }    # emit non-blank lines
	' .branches.txt
}

if ! git show-ref --verify --quiet refs/heads/$1 ; then
    prev=""
else
    prev=$(git rev-parse refs/heads/$1)
fi
base=$(git rev-parse refs/heads/main)

if [[ "$base" == "$prev" ]]; then
    echo "Nothing to do $base == $prev"
    exit 1
fi

git msnap "git mpush $1"

export GIT_INDEX_FILE=$(mktemp)
git read-tree "$base"               # seed from base
# ...stage changes via hash-object + update-index...
list_files_for_branch "$1" | while IFS= read -r f; do
    git add "$f"
done
tree=$(git write-tree)

if [[ "$prev" == "" ]]; then
    commit=$(printf "Update." | git commit-tree "$tree" -p "$base")
    git update-ref refs/heads/$1 "$commit"
else
    commit=$(printf "Update." | git commit-tree "$tree" -p "$prev" -p "$base")
    git update-ref refs/heads/$1 "$commit" "$prev"
fi

rm -f "$GIT_INDEX_FILE"; unset GIT_INDEX_FILE

git push origin "refs/heads/$1"
