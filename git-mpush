#!/bin/bash

set -euo pipefail

if [[ ! -e .git ]]; then
    echo "No git repo found here."
    exit 1
fi

msg="Update."
while [ "$#" -gt 0 ]; do
  case "$1" in
    -m|--message)
      msg="$2"
      shift 2
      ;;
    *)
      branch="$1"
      shift
      ;;
  esac
done

if [[ "$branch" == "" ]]; then
    echo "No branch specified."
    exit 1
fi

function list_files_for_branch() {
	awk -v key="$branch" '
	  $0 ~ "^#[[:space:]]*" key "[[:space:]]*$" { on=1; next }  # start of a wanted section
	  $0 ~ "^#[[:space:]]*"                        { on=0 }     # any header ends current section
	  on && $0 !~ "^[[:space:]]*$"                 { print }    # emit non-blank lines
	' .branches.txt
}

if ! git show-ref --verify --quiet refs/heads/$branch ; then
    prev=""
else
    prev=$(git rev-parse refs/heads/$branch)
fi
base=$(git rev-parse refs/heads/main)

if [[ "$base" == "$prev" ]]; then
    echo "Nothing to do $base == $prev"
    exit 1
fi

git msnap "git mpush $branch"

export GIT_INDEX_FILE=$(mktemp)
git read-tree "$base"               # seed from base
# ...stage changes via hash-object + update-index...
list_files_for_branch "$branch" | while IFS= read -r f; do
    git add "$f"
done
tree=$(git write-tree)

if [[ "$prev" == "" ]]; then
    commit=$(printf "$msg" | git commit-tree "$tree" -p "$base")
    git update-ref refs/heads/$branch "$commit"
else
    commit=$(printf "$msg" | git commit-tree "$tree" -p "$prev" -p "$base")
    git update-ref refs/heads/$branch "$commit" "$prev"
fi

rm -f "$GIT_INDEX_FILE"; unset GIT_INDEX_FILE

git push origin "refs/heads/$branch"

remote_url=$(git config --get remote.origin.url); repo=${remote_url#git@github.com:}; repo=${repo#https://github.com/}; repo=${repo%.git}; echo "https://github.com/$repo/compare/main...$branch"
echo "PR: $remote_url"